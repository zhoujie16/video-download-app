<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<script src="js/mui.min.js"></script>
		<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
		<link href="css/mui.min.css" rel="stylesheet" />
		<script type="text/javascript" charset="utf-8">
			mui.init();
		</script>
	</head>
	<body>
		<script type="text/javascript">
			function dd() {
				var url = plus.storage.getItem('video-url')
				console.log('解析完成', url)
				//下载
				player = plus.video.createVideoPlayer('videoplayer', {
					src: url,
					top: '100px',
					left: '0px',
					width: '100%',
					height: '200px',
					position: 'static'
				});
				plus.webview.currentWebview().append(player);
				$('video source').attr('src', url)
			}
			mui.plusReady(function() {
				console.log('mp')
				plus.storage.setItem('video-url', 'videoUrl')
				var videoUrl = getQueryValue('u')
				if (videoUrl) {
					//下载的地址
					console.log(videoUrl)
				} else {
					test1()
				}
			})

			function test1() {
				const js1 =
					`
				var _this = {
					url: 'https://www.365yg.com/a6628870476011670788#mid=1597448968934414'
				}
				var jqScript = document.createElement('script')
				jqScript.onload = function() {
					var $inp = $("#kw")
					var $btn = $inp.next()
					$inp.val(_this.url);
					$btn.trigger('click')
				}
				jqScript.src = 'https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js'
				jqScript.type = 'text/javascript'
				document.body.append(jqScript)
			`
				const js2 =
					`
					var videoUrl = $('.mn.STYLE4:contains(下载地址) a.link').attr('href');
					if(videoUrl != plus.storage.getItem('video-url')){
						plus.storage.setItem('video-url', videoUrl);
						plus.webview.getLaunchWebview().evalJS("dd()")
					}
					
				`
				const shuoshuUrl = 'http://www.flvcd.com/index.htm'
				var web = plus.webview.create(shuoshuUrl);
				web.addEventListener('loaded', function(e) {
					web.evalJS(js1)
					setTimeout(function() {
						web.evalJS(js2)
					}, 1000)
				}, false);
			}

			function test2() {
				var videoUrl = $('.mn.STYLE4:contains(下载地址) a.link').attr('href')
				alert(videoUrl)
				// plus.webview.getLaunchWebview().evalJS(`dd(${videoUrl})`)
			}


			function getQueryValue(name) {
				let reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
				let subString = location.href.split('?')[1] || '';
				let r = subString.match(reg);
				if (r != null) return decodeURI(r[2]);
				return null;
			}
		</script>
	</body>
</html>
